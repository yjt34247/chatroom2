# 在线聊天室系统 - 2.0版本

## 项目概述

基于Java Servlet技术构建的增强版在线聊天室系统，支持用户登录、私聊、群聊、在线用户管理、会话监控等功能。采用清晰的MVC架构设计，提供更好的用户体验和系统稳定性。

## 🏗️ 系统架构设计

### MVC架构设计

#### **模型层（Model）**
- **User实体类**：封装用户信息（用户名、登录时间、会话ID、最后活动时间）
- **Message实体类**：封装消息信息（发送者、接收者、内容、时间戳、消息类型）

#### **视图层（View）**
- **JSP页面**：
  - `index.jsp`：登录页面，支持错误信息显示
  - `chat.jsp`：主聊天页面，集成消息区和在线用户列表
  - `logout.jsp`：退出确认页面
- **CSS样式**：`style.css`，响应式布局设计
- **JavaScript**：内嵌于JSP页面，实现动态交互

#### **控制层（Controller）**
- **LoginController**：处理用户登录，`@WebServlet("/login")`
- **LogoutController**：处理用户退出，`@WebServlet("/logout")`
- **MessageController**：统一消息处理（发送和获取），`@WebServlet("/message")`
- **UserController**：在线用户管理，`@WebServlet("/getOnlineUsers")`
- **UserLeaveController**：处理异常退出，`@WebServlet("/userLeave")`

### 服务层设计
- **UserService**：用户管理服务，使用`ConcurrentHashMap`存储在线用户
- **MessageService**：消息管理服务，使用`CopyOnWriteArrayList`存储消息
- **支持功能**：用户活动跟踪、不活跃用户清理、消息过滤

### 过滤器与监听器
- **AuthenticationFilter**：认证过滤器，保护受限资源
- **SessionLifecycleListener**：会话生命周期监听器，处理异常退出

## 🚀 相比1.0版本的新增功能

### 1. **私聊功能**
- 支持用户之间的私密聊天
- 消息选择器：可向"所有人"或指定用户发送消息
- 私聊消息特殊标记，区分群聊和私聊

### 2. **智能会话管理**
- **活动时间追踪**：记录用户最后活动时间
- **会话控制**：Session超时 
- **异常退出处理**：通过监听器自动清理

### 3. **消息类型系统**
- **系统消息**：用户加入/退出通知
- **群聊消息**：向所有用户广播
- **私聊消息**：点对点加密式通信
- **时间戳显示**：每条消息显示发送时间

### 4. **增强的用户界面**
- 左右分栏布局：聊天区 + 在线用户列表
- 实时用户计数：显示当前在线人数
- 响应式设计：适配不同屏幕尺寸
- 消息分类样式：不同消息类型不同颜色

### 5. **前端优化**
- **页面保活**：定时轮询保持会话活跃
- **离开通知**：页面关闭时通知服务器
- **可见性检测**：页面切换时自动刷新
- **快捷键支持**：回车发送消息

## 📁 项目结构

```
chatroom-2.0/
├── src/main/java/com/example/chatroom/
│   ├── controller/                    # 控制器层
│   │   ├── LoginController.java
│   │   ├── LogoutController.java
│   │   ├── MessageController.java
│   │   ├── UserController.java
│   │   └── UserLeaveController.java
│   ├── entity/                        # 实体类
│   │   ├── Message.java
│   │   └── User.java
│   ├── service/                       # 服务层
│   │   ├── MessageService.java
│   │   └── UserService.java
│   ├── filter/                        # 过滤器
│   │   └── AuthenticationFilter.java
│   └── listener/                      # 监听器
│       └── SessionLifecycleListener.java
├── src/main/webapp/
│   ├── index.jsp                      # 登录页面
│   ├── chat.jsp                       # 聊天主页面
│   ├── logout.jsp                     # 退出页面
│   ├── css/
│   │   └── style.css                  # 样式文件
│   ├── WEB-INF/
│       └── web.xml                    # 部署描述符
│   
├── pom.xml                            # Maven依赖配置
└── README.md                          # 项目说明
```

## 🔧 技术栈

### 后端技术
- **Java 17**：编程语言
- **Servlet 6.0** (Jakarta EE)：Web框架
- **Maven 3.6+**：项目构建和依赖管理

### 前端技术
- **JSP 3.0**：动态页面渲染
- **JavaScript**：客户端交互
- **CSS**：样式设计
- **Fetch API**：异步请求

### 运行环境
- **Servlet容器**：Tomcat 10+ 
- **JDK版本**：OpenJDK 17+
- **字符编码**：UTF-8

## 📋 使用说明

#### 登录阶段
1. 访问应用首页
2. 输入唯一用户名（不能与在线用户重复）
3. 点击"进入聊天室"按钮
4. 系统显示欢迎消息

#### 聊天阶段
1. **发送消息**：
   - 选择接收者："所有人"或指定用户
   - 输入消息内容
   - 点击"发送"或按回车键

2. **查看消息**：
   - 群聊消息：所有用户可见
   - 私聊消息：仅发送者和接收者可见
   - 系统消息：所有用户可见

3. **用户管理**：
   - 右侧显示在线用户列表
   - 实时更新用户数量
   - 可点击用户名进行私聊

#### 退出阶段
1. **正常退出**：点击"退出"链接
2. **异常退出**：关闭浏览器或标签页
3. **超时退出**：超过20秒无活动自动退出

## ⚙️ 核心配置

### Session配置
- **超时时间**：20秒无活动自动过期
- **会话同步**：Session与在线用户列表保持同步

### 消息配置
- **最大消息数**：1000条（内存限制）
- **消息保留**：循环队列，超出自动删除旧消息
- **时间格式**：HH:mm:ss 显示格式

### 安全配置
- **登录验证**：用户名唯一性检查
- **访问控制**：所有受限资源需要登录
- **数据清理**：退出时清理所有关联数据

## 🔍 系统特性

### 优势特性
1. **模块化设计**：清晰的MVC分层，便于维护和扩展
2. **线程安全**：使用并发集合，支持多用户并发访问
3. **实时性强**：5秒轮询间隔，准实时消息更新
4. **用户体验好**：私聊、群聊、用户列表等完整功能
5. **容错能力强**：自动处理异常退出，系统稳定性高

### 监控与日志
- 控制台输出详细的系统日志
- 实时显示用户登录/退出状态
- 监控系统清理不活跃用户
- 显示消息发送和接收统计

## 🚨 注意事项

1. **用户名唯一性**：不能与在线用户重名
2. **会话超时**：20秒无操作会自动退出
3. **消息限制**：最多保留1000条消息
4. **私聊隐私**：私聊消息仅双方可见
5. **浏览器兼容**：建议使用Chrome/Firefox等现代浏览器

## 📈 性能优化

### 已实现的优化
- **内存管理**：限制消息数量，防止内存溢出
- **并发处理**：使用线程安全集合
- **请求合并**：减少不必要的网络请求
- **本地存储**：减少数据库依赖

## 🔄 版本对比

| 特性 | v1.0 | v2.0 |
|------|------|------|
| 架构模式 | 简单Servlet | MVC分层架构 |
| 消息类型 | 仅群聊 | 群聊 + 私聊 |
| 用户管理 | 基础列表 | 活动追踪 + 自动清理 |
| 会话管理 | 简单超时 | 异常处理 |
| 前端技术 | HTML + JS | JSP + 内嵌JS |
| 并发安全 | 数组操作 | 并发集合 |
| 系统消息 | 无 | 加入/退出通知 |
| 用户体验 | 基础界面 | 分栏布局 + 实时计数 |
